{"posts":[{"title":"gitçš„å¸¸ç”¨æ“ä½œ","text":"1.1 é…ç½®ç”¨æˆ·åå’Œé‚®ç®±12git config --global user.name &quot;&quot;git config --global user.email &quot;&quot; 1.2 å¼ºåˆ¶æ·»åŠ è¢«å¿½ç•¥æ–‡ä»¶æ·»åŠ ä¸€ä¸ªè¢«.gitignoreæ–‡ä»¶å¿½ç•¥çš„æ–‡ä»¶ï¼Œå¯ä»¥æ·»åŠ -få‚æ•° 1git add -f App.class 1.3 æš‚å­˜stashâ€‹ å½“æ‚¨æƒ³è®°å½•å·¥ä½œç›®å½•å’Œç´¢å¼•çš„å½“å‰çŠ¶æ€ï¼Œä½†åˆæƒ³è¿”å›ä¸€ä¸ªå¹²å‡€çš„å·¥ä½œç›®å½•æ—¶ï¼Œè¯·ä½¿ç”¨git stashã€‚è¯¥å‘½ä»¤å°†ä¿å­˜æœ¬åœ°ä¿®æ”¹ï¼Œå¹¶æ¢å¤å·¥ä½œç›®å½•ä»¥åŒ¹é…å¤´éƒ¨æäº¤ã€‚ 1234567891011121314151617181920# ä¿å­˜å½“å‰æœªcommitçš„ä»£ç git stash# ä¿å­˜å½“å‰æœªcommitçš„ä»£ç å¹¶æ·»åŠ å¤‡æ³¨git stash save &quot;å¤‡æ³¨çš„å†…å®¹&quot;# åˆ—å‡ºstashçš„æ‰€æœ‰è®°å½•git stash list# åˆ é™¤stashçš„æ‰€æœ‰è®°å½•git stash clear# åº”ç”¨æœ€è¿‘ä¸€æ¬¡çš„stashgit stash apply# åº”ç”¨æœ€è¿‘ä¸€æ¬¡çš„stashï¼Œéšååˆ é™¤è¯¥è®°å½•git stash pop# åˆ é™¤æœ€è¿‘çš„ä¸€æ¬¡stashgit stash drop 1.4 GITä¿®æ”¹commitä¿¡æ¯12345678# æäº¤æš‚å­˜åŒºåˆ°ä»“åº“åŒºgit commit -m [message]å‘½ä»¤ï¼šgit commit --amendåœºæ™¯ä¸€ï¼šgit commit -m æäº¤ä¹‹åï¼Œå‘ç°-mçš„è¯´æ˜æ–‡å­—å†™çš„æœ‰é—®é¢˜ï¼Œæƒ³è¦é‡æ–°å†™ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯æƒ³æ’¤é”€ä¸Šæ¬¡çš„æäº¤åŠ¨ä½œï¼Œé‡æ–°æäº¤ä¸€æ¬¡åœºæ™¯äºŒï¼šæäº¤ä»£ç æ—¶ï¼Œå‘ç°æäº¤çš„æ–‡ä»¶ä¸­éœ€è¦ä¿®æ”¹æˆ–è€…è¿˜æœ‰æ–‡ä»¶æœªä¿®æ”¹ã€‚ é‡æ–°æäº¤æ˜¯åœ¨æ—¥å¿—çœ‹ä¸åˆ°æ“ä½œè®°å½•çš„ã€‚ä½¿ç”¨ä¸€æ¬¡æ–°çš„commitï¼Œæ›¿ä»£ä¸Šä¸€æ¬¡æäº¤å¦‚æœä»£ç æ²¡æœ‰ä»»ä½•æ–°å˜åŒ–ï¼Œåˆ™ç”¨æ¥æ”¹å†™ä¸Šä¸€æ¬¡commitçš„æäº¤ä¿¡æ¯ 1.5 ç‰ˆæœ¬å›é€€â€‹ å›é€€ä½ å·²æäº¤çš„ commitï¼Œå¹¶å°† commit çš„ä¿®æ”¹å†…å®¹æ”¾å›åˆ°æš‚å­˜åŒºã€‚ 12345678# æ¢å¤æœ€è¿‘ä¸€æ¬¡ commitgit reset --soft HEAD^git reset --hard HEAD^ #å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬git reset --hard HEAD^^ #å›æ»šåˆ°ä¸Šä¸Šä¸€ç‰ˆæœ¬ï¼šgit reset --hard cb926e7 #å›é€€åˆ°å…·ä½“æŸä¸ªç‰ˆgit reset --keep [commit] # é‡ç½®å½“å‰HEADä¸ºæŒ‡å®šcommitï¼Œä½†ä¿æŒæš‚å­˜åŒºå’Œå·¥ä½œåŒºä¸å˜ å¯¹äºä¸Šé¢çš„åœºæ™¯ï¼Œå°±å¯ä»¥å†æ¬¡ä¿®æ”¹é‡æ–°æäº¤ï¼Œä¿æŒå¹²å‡€çš„ commit è®°å½•,åœ¨ reset --soft æŒ‡å®š commit å·æ—¶ï¼Œä¼šå°†è¯¥ commit åˆ°æœ€è¿‘ä¸€æ¬¡ commit çš„æ‰€æœ‰ä¿®æ”¹å†…å®¹å…¨éƒ¨æ¢å¤ï¼Œè€Œä¸æ˜¯åªé’ˆå¯¹è¯¥ commitã€‚ 1.6 åˆ é™¤gitä¸Šçš„æ–‡ä»¶ï¼Œå¦‚node_modules12345// node_modules ä½ è¦åˆ é™¤çš„å…¶ä»–æ–‡ä»¶// master æäº¤çš„åˆ†æ”¯git rm -r --cached node_modulesgit commit -m 'node_modules'git push origin master 1.7 tagæ ‡ç­¾çš„ä½¿ç”¨123456789101112131415git tag # åˆ—å‡ºå½“å‰ä»“åº“çš„æ‰€æœ‰æ ‡ç­¾git tag -l 'v0.1.*' # æœç´¢ç¬¦åˆå½“å‰æ¨¡å¼çš„æ ‡ç­¾ git tag v0.2.1-light # åˆ›å»ºè½»é‡æ ‡ç­¾git tag -a v0.2.1 -m '0.2.1ç‰ˆæœ¬' # åˆ›å»ºé™„æ³¨æ ‡ç­¾ git checkout [tagname] # åˆ‡æ¢åˆ°æ ‡ç­¾git show v0.2.1 # æŸ¥çœ‹æ ‡ç­¾ç‰ˆæœ¬ä¿¡æ¯ git tag -d v0.2.1 # åˆ é™¤æ ‡ç­¾git tag -a v0.2.1 9fbc3d0 # è¡¥æ‰“æ ‡ç­¾ git push origin v0.1.2 # å°†v0.1.2æ ‡ç­¾æäº¤åˆ°gitæœåŠ¡å™¨git push origin â€“tags # å°†æœ¬åœ°æ‰€æœ‰æ ‡ç­¾ä¸€æ¬¡æ€§æäº¤åˆ°gitæœåŠ¡å™¨git tag # æŸ¥çœ‹å½“å‰åˆ†æ”¯ä¸‹çš„æ ‡ç­¾ 1.8 åˆ†æ”¯1234567891011121314151617181920212223242526272829git branch # åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯git branch -r # åˆ—å‡ºæ‰€æœ‰è¿œç¨‹åˆ†æ”¯git branch -a # åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯å’Œè¿œç¨‹åˆ†æ”¯git branch [branch-name] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œä½†ä¾ç„¶åœç•™åœ¨å½“å‰åˆ†æ”¯git checkout -b [branch] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯git branch [branch] [commit] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼ŒæŒ‡å‘æŒ‡å®šcommitgit branch --track [branch] [remote-branch] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œä¸æŒ‡å®šçš„è¿œç¨‹åˆ†æ”¯å»ºç«‹è¿½è¸ªå…³ç³»git checkout [branch-name] # åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯ï¼Œå¹¶æ›´æ–°å·¥ä½œåŒºgit checkout - # åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªåˆ†æ”¯git branch --set-upstream [branch] [remote-branch] # å»ºç«‹è¿½è¸ªå…³ç³»ï¼Œåœ¨ç°æœ‰åˆ†æ”¯ä¸æŒ‡å®šçš„è¿œç¨‹åˆ†æ”¯ä¹‹é—´git merge [branch] # åˆå¹¶æŒ‡å®šåˆ†æ”¯åˆ°å½“å‰åˆ†æ”¯git cherry-pick [commit] # é€‰æ‹©ä¸€ä¸ªcommitï¼Œåˆå¹¶è¿›å½“å‰åˆ†æ”¯git branch -d [branch-name] # åˆ é™¤åˆ†æ”¯# åˆ é™¤è¿œç¨‹åˆ†æ”¯git push origin --delete [branch-name]git branch -dr [remote/branch] æŠ¥é”™è§£å†³ Cannot do a soft reset in the middle of a merge1git merge --abort","link":"/2023/11/19/git/git%E7%9A%84%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/"},{"title":"å¤§æ–‡ä»¶åˆ‡ç‰‡ä¸Šä¼ ","text":"å®Œæ•´ä»£ç è·å– å®ç°æ€è·¯ï¼š åˆ‡ç‰‡ä¸Šä¼ æ˜¯æŒ‡å°†ä¸€ä¸ªå¤§æ–‡ä»¶åˆ‡å‰²ä¸ºè‹¥å¹²ä¸ªå°æ–‡ä»¶ï¼Œåˆ†ä¸ºå¤šä¸ªè¯·æ±‚ä¾æ¬¡ä¸Šä¼ ï¼Œåå°å†å°†æ–‡ä»¶ç¢ç‰‡æ‹¼æ¥ä¸ºä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ã€‚ å®ç°çš„åŠŸèƒ½ï¼š æ–‡ä»¶åˆ‡ç‰‡ä¸Šä¼  å¤šçº¿ç¨‹å¤„ç†æ–‡ä»¶åˆ‡ç‰‡ä»»åŠ¡ ä¸Šä¼ æš‚åœ æ–­ç‚¹ç»­ä¼  1.æ–‡ä»¶åˆ‡ç‰‡é€‰æ‹©æ–‡ä»¶ï¼Œå¹¶ä¸”å¯¹æ–‡ä»¶çš„ç±»å‹è¿›è¡Œæ ¡éªŒï¼Œé™åˆ¶æ–‡ä»¶ä¸Šä¼ çš„ç±»å‹ï¼Œè®¾ç½®æ¯ä¸ªåˆ‡ç‰‡çš„å¤§å°ï¼Œè¿›è¡Œæ–‡ä»¶åˆ‡ç‰‡ æ–‡ä»¶åˆ‡ç‰‡å’Œæ ¸å¿ƒæ˜¯ä½¿ç”¨ Blob å¯¹è±¡çš„ slice æ–¹æ³• å¯¹æ–‡ä»¶çš„å¤„ç†ç¦»ä¸å¼€Fileå¯¹è±¡ã€‚Fileæä¾›äº†æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ï¼Œå®ƒç»§æ‰¿äºBlobå¯¹è±¡ï¼Œå¹¶æ·»åŠ äº†name(æ–‡ä»¶å)ã€lastModified(æœ€åä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´æˆ³)ç­‰å±æ€§ã€‚ 12345678910111213141516171819202122232425262728293031323334// åˆ‡ç‰‡å¤§å° const SIZE = 10 * 1024 * 1024; let hashPercentage = ref(0); //ç”Ÿæˆhashè¿›åº¦ let fakeUploadPercentage = ref(0); //ä¸Šä¼ è¿›åº¦ let data = ref([]); let XMLHttpRequestList = ref([]); const reset = () =&gt; { hashPercentage.value = 0; fakeUploadPercentage.value = 0; };/** * é€‰æ‹©æ–‡ä»¶ */const handleFileChange = (e) =&gt; { const [file] = e.target.files; if (!file) return; if (!allowType[file.type]) { console.log(&quot;ä¸æ”¯æŒè¯¥ç±»å‹æ–‡ä»¶ä¸Šä¼ ï¼&quot;); return; } container.file = file;};// ç”Ÿæˆæ–‡ä»¶åˆ‡ç‰‡const createFileChunk = (file, size = SIZE) =&gt; { const fileChunkList = []; let cur = 0; while (cur &lt; file.size) { fileChunkList.push({ file: file.slice(cur, cur + size) }); cur += size; } return fileChunkList;}; 2. å¤šçº¿ç¨‹æ–‡ä»¶åˆ‡ç‰‡ ä¸‹é¢ä½¿ç”¨ spark-md5 åº“æ¥æ ¹æ®æ–‡ä»¶å†…å®¹è®¡ç®—å‡ºæ–‡ä»¶çš„ MD5 å€¼ï¼ŒMD5å€¼æ˜¯ç”¨æ¥ä¼ ç»™åç«¯ç”¨äºç§’ä¼ åŠŸèƒ½å’Œåˆ†å—ä¸Šä¼ çš„æ ‡è¯†ã€‚ æµè§ˆå™¨æ‰§è¡Œç¯å¢ƒæ˜¯å•çº¿ç¨‹çš„ï¼Œä¸€æ—¦å‡ºç°ã€ä¸»çº¿ç¨‹ã€‘è€—æ—¶æ“ä½œï¼Œå°±ä¼šé€ æˆæµè§ˆå™¨å¡æ­»ï¼Œç”¨æˆ·ç‚¹å‡»æ²¡å“åº”ç­‰æƒ…å†µï¼Œé—®ä»·åˆ‡ç‰‡å¯èƒ½é€ æˆé¡µé¢é•¿æ—¶é—´æ²¡æœ‰å“åº”ï¼Œç”¨æˆ·ä¸èƒ½è¿›è¡Œé¡µé¢æ“ä½œï¼Œç”¨æˆ·çš„ä½¿ç”¨æ„Ÿå—ä¼šå¤§å¤§é™ä½ï¼Œè¿™æ—¶å€™ä½¿ç”¨workersç‹¬ç«‹äºä¸»çº¿ç¨‹è¿è¡Œçš„å­çº¿ç¨‹ã€‚å¯ä»¥å°†ä¸€äº›å¯èƒ½ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ–‡ä»¶åˆ‡ç‰‡æ“ä½œï¼Œä¸¢åœ¨ Worker é‡Œå»å•ç‹¬æ‰§è¡Œã€‚ ä½¿ç”¨çº¿ç¨‹éœ€è¦æ³¨æ„ï¼š åŒæºé™åˆ¶ï¼šåˆ›å»º worker çº¿ç¨‹çš„æ—¶å€™éœ€è¦åˆ†é…ä¸€ä¸ª JS æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¿…é¡»æ˜¯åŒæºçš„ï¼Œä¸”ä¸èƒ½æ˜¯æœ¬åœ°æ–‡ä»¶ï¼› ç¯å¢ƒéš”ç¦»ï¼šworker çº¿ç¨‹æ‰€åœ¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸ä¸»çº¿ç¨‹ä¸ä¸€æ ·ï¼Œæ— æ³•è¯»å–ç½‘é¡µçš„ DOM å¯¹è±¡ï¼Œå…¨å±€å¯¹è±¡ä¸å†æ˜¯ windowï¼Œå¯ä»¥é€šè¿‡ this æˆ– self è®¿é—®ã€‚ é€šä¿¡å—é™ï¼šä¸»çº¿ç¨‹å’Œ worker çº¿ç¨‹ä¸èƒ½ç›´æ¥é€šä¿¡ï¼Œé€šè¿‡ postMessage æ–¹æ³•è¿›è¡Œæ¶ˆæ¯ä¼ é€’ã€‚ å‰ç«¯ä»£ç ä¸ºï¼š 12345678910111213141516// ç”Ÿæˆæ–‡ä»¶ hash const calculateHash = (fileChunkList) =&gt; { return new Promise((resolve) =&gt; { container.worker = new Worker(&quot;/hash.js&quot;); //å‘é€ä¿¡æ¯åˆ°workerè¿›ç¨‹ container.worker.postMessage({ fileChunkList }); // ç›‘å¬æ¥æ”¶workerè¿›ç¨‹ä¿¡æ¯ container.worker.onmessage = (e) =&gt; { const { percentage, hash } = e.data; hashPercentage.value = percentage; if (hash) { resolve(hash); } }; }); }; 3. ä¸Šä¼ å‰æ–‡ä»¶æ ¡éªŒåœ¨æ–‡ä»¶åˆ‡ç‰‡å¼€å§‹ä¸Šä¼ ä¹‹å‰ï¼Œéœ€è¦å°†åˆ‡ç‰‡çš„ä¿¡æ¯ä¼ é€’åˆ°åç«¯è¿›è¡Œæ ¡éªŒï¼Œåˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯å¦æ˜¯ä¸Šä¼ è¿‡çš„ï¼Œå¦‚æœä¸Šä¼ è¿‡çš„è¯å®ç°ç§’ä¼ ï¼Œåç«¯ä»£ç ä¸ºï¼š 123456789101112131415161718192021// éªŒè¯æ˜¯å¦å·²ä¸Šä¼ /å·²ä¸Šä¼ åˆ‡ç‰‡ä¸‹æ ‡ async handleVerifyUpload(req, res) { const data = await resolvePost(req); const { fileHash, filename } = data; const ext = extractExt(filename); const filePath = path.resolve(UPLOAD_DIR, `${fileHash}${ext}`); if (fse.existsSync(filePath)) { res.end( JSON.stringify({ shouldUpload: false }) ); } else { res.end( JSON.stringify({ shouldUpload: true, uploadedList: await createUploadedList(fileHash) }) ); } } 1234567891011121314151617181920212223242526272829303132const handleUpload = async () =&gt; { if (!container.file) return; reset(); // æ–‡ä»¶åˆ‡ç‰‡ const fileChunkList = createFileChunk(container.file); console.log(fileChunkList, &quot;fileChunkList&quot;); // ç”Ÿæˆæ–‡ä»¶hash container.hash = (await calculateHash(fileChunkList)) as string; // éªŒè¯ const { shouldUpload, uploadedList } = await verifyUpload( container.file.name, container.hash ); if (!shouldUpload) { return; } data.value = fileChunkList.map(({ file }, index) =&gt; ({ fileHash: container.hash, index, hash: container.hash + &quot;-&quot; + index, chunk: file, size: file.size, percentage: uploadedList.includes(index) ? 100 : 0, })); await uploadChunks(uploadedList);}; 4. æ–‡ä»¶ä¸Šä¼ æ–‡ä»¶æ ¡éªŒå®Œæ¯•ä¹‹åï¼Œæ­£å¼è¿›è¡Œæ–‡ä»¶çš„ä¸Šä¼ ï¼š æ—§ç‰ˆçš„ XMLHttpRequest æ˜¯ä¸æ”¯æŒæ˜¾ç¤ºè¿›åº¦çš„ï¼Œå‡çº§ä¸º Level 2 ä¹‹åï¼Œæœ‰ä¸€ä¸ª progress äº‹ä»¶ï¼Œç”¨æ¥è¿”å›è¿›åº¦ä¿¡æ¯ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯¥åœºæ™¯ä¸‹æ¨èä½¿ç”¨ xhr ï¼Œè€Œä¸ä½¿ç”¨ fetch çš„åŸå› ã€‚fetch ä¸æä¾›ç›¸å…³çš„æ¥å£ï¼Œæˆ‘ä»¬æ— æ³•è·å¾—æ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ onprogress äº‹ä»¶æ¥å®æ—¶æ˜¾ç¤ºè¿›åº¦ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªäº‹ä»¶æ¯ 50ms è§¦å‘ä¸€æ¬¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šä¼ è¿‡ç¨‹å’Œä¸‹è½½è¿‡ç¨‹è§¦å‘çš„æ˜¯ä¸åŒå¯¹è±¡çš„ onprogress äº‹ä»¶ï¼šä¸Šä¼ è§¦å‘çš„æ˜¯ xhr.upload å¯¹è±¡çš„ onprogress äº‹ä»¶ï¼Œä¸‹è½½è§¦å‘çš„æ˜¯ xhrå¯¹è±¡çš„ onprogress äº‹ä»¶ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748 // ä¸Šä¼ åˆ‡ç‰‡ const uploadChunks = async (uploadedList = []) =&gt; { const requestList = data.value .filter(({ hash }) =&gt; !uploadedList.includes(hash)) .map(({ chunk, hash, index }) =&gt; { const formData = new FormData(); formData.append(&quot;chunk&quot;, chunk); formData.append(&quot;hash&quot;, hash); formData.append(&quot;filename&quot;, container.file.name); formData.append(&quot;fileHash&quot;, container.hash); return { formData, index }; }) .map(({ formData, index }) =&gt; request({ url: &quot;http://localhost:3000&quot;, data: formData, onProgress: createProgressHandler(data.value[index]), requestList: XMLHttpRequestList.value, }) ); await Promise.all(requestList); // ä¹‹å‰ä¸Šä¼ çš„åˆ‡ç‰‡æ•°é‡ + æœ¬æ¬¡ä¸Šä¼ çš„åˆ‡ç‰‡æ•°é‡ = æ‰€æœ‰åˆ‡ç‰‡æ•°é‡æ—¶åˆå¹¶åˆ‡ç‰‡ if (uploadedList.length + requestList.length === data.value.length) { await mergeRequest(); } }; // ä¿å­˜æ¯ä¸ª chunk çš„è¿›åº¦æ•°æ® const createProgressHandler = (item) =&gt; { return (e) =&gt; { item.percentage = parseInt(String((e.loaded / e.total) * 100)); }; };// è¿›åº¦ const uploadPercentage = computed(() =&gt; { if (!data.value.length) return 0; const loaded = data.value .map((item) =&gt; item.size * item.percentage) .reduce((acc, cur) =&gt; acc + cur); return parseInt((loaded / container.file.size).toFixed(2)); }); watch(uploadPercentage, (now) =&gt; { if (now &gt; fakeUploadPercentage.value) { fakeUploadPercentage.value = now; } }); åç«¯ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243async handleFormData(req, res) { const multipart = new multiparty.Form(); multipart.parse(req, async (err, fields, files) =&gt; { if (err) { console.error(err); res.status = 500; res.end(&quot;process file chunk failed&quot;); return; } const [chunk] = files.chunk; const [hash] = fields.hash; const [fileHash] = fields.fileHash; const [filename] = fields.filename; const filePath = path.resolve( UPLOAD_DIR, `${fileHash}${extractExt(filename)}` ); const chunkDir = getChunkDir(fileHash); const chunkPath = path.resolve(chunkDir, hash); // æ–‡ä»¶å­˜åœ¨ç›´æ¥è¿”å› if (fse.existsSync(filePath)) { res.end(&quot;file exist&quot;); return; } // åˆ‡ç‰‡å­˜åœ¨ç›´æ¥è¿”å› if (fse.existsSync(chunkPath)) { res.end(&quot;chunk exist&quot;); return; } // åˆ‡ç‰‡ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆ‡ç‰‡ç›®å½• if (!fse.existsSync(chunkDir)) { await fse.mkdirs(chunkDir); } // fs-extra çš„ rename æ–¹æ³• windows å¹³å°ä¼šæœ‰æƒé™é—®é¢˜ await fse.move(chunk.path, path.resolve(chunkDir, hash)); res.end(&quot;received file chunk&quot;); });} 5. æ–‡ä»¶åˆå¹¶æ–‡ä»¶ä¸Šä¼ å®Œæ¯•ä¹‹åï¼Œé€šçŸ¥åç«¯è¿›è¡Œæ–‡ä»¶åˆå¹¶æ“ä½œï¼š 123456789101112131415// é€šçŸ¥æœåŠ¡ç«¯åˆå¹¶åˆ‡ç‰‡ const mergeRequest = async () =&gt; { await request({ url: &quot;http://localhost:3000/merge&quot;, headers: { &quot;content-type&quot;: &quot;application/json&quot;, }, data: JSON.stringify({ size: SIZE, fileHash: container.hash, filename: container.file.name, }), }); console.log(&quot;upload success, check /target directory&quot;); }; åç«¯ä»£ç ä¸ºï¼š 1234567891011121314151617181920212223242526272829303132333435363738// åˆå¹¶åˆ‡ç‰‡ async handleMerge(req, res) { const data = await resolvePost(req); const { fileHash, filename, size } = data; const ext = extractExt(filename); const filePath = path.resolve(UPLOAD_DIR, `${fileHash}${ext}`); await mergeFileChunk(filePath, fileHash, size); res.end( JSON.stringify({ code: 0, message: &quot;file merged success&quot; }) ); }// åˆå¹¶åˆ‡ç‰‡const mergeFileChunk = async (filePath, fileHash, size) =&gt; { const chunkDir = getChunkDir(fileHash); const chunkPaths = await fse.readdir(chunkDir); // æ ¹æ®åˆ‡ç‰‡ä¸‹æ ‡è¿›è¡Œæ’åº // å¦åˆ™ç›´æ¥è¯»å–ç›®å½•çš„è·å¾—çš„é¡ºåºä¼šé”™ä¹± chunkPaths.sort((a, b) =&gt; a.split(&quot;-&quot;)[1] - b.split(&quot;-&quot;)[1]); // å¹¶å‘å†™å…¥æ–‡ä»¶ await Promise.all( chunkPaths.map((chunkPath, index) =&gt; pipeStream( path.resolve(chunkDir, chunkPath), // æ ¹æ® size åœ¨æŒ‡å®šä½ç½®åˆ›å»ºå¯å†™æµ fse.createWriteStream(filePath, { start: index * size }) ) ) ); // åˆå¹¶ååˆ é™¤ä¿å­˜åˆ‡ç‰‡çš„ç›®å½• fse.rmdirSync(chunkDir);}; 6. ä¸Šä¼ æš‚åœæš‚åœæ–‡ä»¶çš„ä¸Šä¼ ï¼š 1234567const resetData = async () =&gt; { XMLHttpRequestList.value.forEach((xhr) =&gt; xhr.abort()); XMLHttpRequestList.value = []; if (container.worker) { container.worker.onmessage = null; } }; 7. ç»§ç»­ä¸Šä¼ 1234567const handleResume = async () =&gt; { const { uploadedList } = await verifyUpload( container.file.name, container.hash ); await uploadChunks(uploadedList); };","link":"/2024/03/04/vue/%E5%88%87%E7%89%87%E4%B8%8A%E4%BC%A0/"},{"title":"å®ç°ä¸€ä¸ªWebSocketå³æ—¶é€šè®¯èŠå¤©","text":"æ•´ä½“æ¶æ„å®Œæ•´ä»£ç è·å– å‰ç«¯ï¼šVueæ­å»º+websockå®¢æˆ·ç«¯ åç«¯ï¼šnodeJs+websockæœåŠ¡ç«¯ â€‹ WebSocket æ˜¯ä¸€ç§æ”¯æŒåŒå‘é€šä¿¡çš„åè®®ï¼Œé€šè¿‡åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹æŒä¹…è¿æ¥ï¼Œå¯ä»¥å®ç°å®æ—¶çš„åŒå‘æ•°æ®ä¼ è¾“ã€‚WebSocket é€‚ç”¨äºéœ€è¦å®æ—¶æ€§å’Œä½å»¶è¿Ÿçš„åº”ç”¨ï¼Œä¾‹å¦‚åœ¨çº¿èŠå¤©åº”ç”¨æˆ–å®æ—¶æ¸¸æˆã€‚ â€‹ WebSocketæ˜¯å¦ä¸€ç§ç½‘ç»œåè®®ï¼Œä½†æ²¡æœ‰å®Œå…¨è„±ç¦»HTTPï¼Œæ¡æ‰‹é˜¶æ®µé‡‡ç”¨çš„å°±æ˜¯HTTPåè®®ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„å°±æ˜¯ä¸æ˜“è¢«å±è”½ï¼Œèƒ½é€šè¿‡å„ç§HTTPä»£ç†æœåŠ¡å™¨ï¼› â€‹ WebSocketæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œå½“ç„¶ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨çš„å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ã€‚è€Œæ™®é€šçš„HTTPåè®®åªèƒ½ç”±å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ï¼ŒæœåŠ¡å™¨æ ¹æ®å†…å®¹è¿›è¡Œè¿”å›ã€‚ WebSocketæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š æ˜¯çœŸæ­£çš„å…¨åŒå·¥æ–¹å¼ï¼Œå»ºç«‹è¿æ¥åå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯æ˜¯å®Œå…¨å¹³ç­‰çš„ï¼Œå¯ä»¥äº’ç›¸ä¸»åŠ¨è¯·æ±‚ã€‚è€ŒHTTPé•¿è¿æ¥åŸºäºHTTPï¼Œæ˜¯ä¼ ç»Ÿçš„å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨å‘èµ·è¯·æ±‚çš„æ¨¡å¼ã€‚ HTTPé•¿è¿æ¥ä¸­ï¼Œæ¯æ¬¡æ•°æ®äº¤æ¢é™¤äº†çœŸæ­£çš„æ•°æ®éƒ¨åˆ†å¤–ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¿˜è¦å¤§é‡äº¤æ¢HTTP headerï¼Œä¿¡æ¯äº¤æ¢æ•ˆç‡å¾ˆä½ã€‚Websocketåè®®é€šè¿‡ç¬¬ä¸€ä¸ªrequestå»ºç«‹äº†TCPè¿æ¥ä¹‹åï¼Œä¹‹åäº¤æ¢çš„æ•°æ®éƒ½ä¸éœ€è¦å‘é€ HTTP headerå°±èƒ½äº¤æ¢æ•°æ®ã€‚ å‰ç«¯å®ç°ï¼šè¾“å…¥ç”¨æˆ·ååŠ å…¥èŠå¤©å®¤ ç‚¹å‡»ç”¨æˆ·å¤´åƒè¿›è¡Œç§èŠï¼š 12345678910111213141516171819202122232425262728&lt;template&gt; &lt;div class='chat'&gt; &lt;mainContainer&gt; &lt;Contacts :curUser=&quot;curUser&quot; :userList=&quot;userList&quot; :curUserId=&quot;curUser.id&quot; :chatUser=&quot;chatUser&quot; @click-user=&quot;handleClickAvatar&quot; &gt;&lt;/Contacts&gt; &lt;!-- ç¾¤èŠ --&gt; &lt;publicChat v-if=&quot;chatType == 'qunliao'&quot; :chatData=&quot;chatData&quot; @send=&quot;handleSend&quot; @click-user=&quot;handleClickAvatar&quot; &gt;&lt;/publicChat&gt; &lt;!-- ç§èŠ --&gt; &lt;personalChat v-else :chatData=&quot;userChatData.get(chatUserId) ?? []&quot; :chatUser=&quot;chatUser&quot; @send=&quot;handleSendUser&quot; &gt;&lt;/personalChat&gt; &lt;/mainContainer&gt; &lt;JoinModel @join=&quot;handleJoin&quot;/&gt; &lt;/div&gt;&lt;/template&gt; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154import { io } from 'socket.io-client'import { reactive, ref } from 'vue'export default () =&gt; { // åˆ›å»º socket å®ä¾‹ const socket = io('ws://localhost:5433') interface ChatDataItem { type: 'your' | 'me' | 'tips' id: string name?: string content: string avatar?: string userId?: string } // ç›‘å¬ join const handleJoin = (e:any) =&gt; { socket.emit('join', Object.assign({}, e)) } const curUser = reactive({ //å½“å‰ç™»é™†çš„ç”¨æˆ·ä¿¡æ¯ name: '', avatar: '', id: '', }) // è·å–å½“å‰åŠ å…¥ç¾¤èŠä¿¡æ¯ socket.on('joined', (e: typeof curUser) =&gt; { curUser.avatar = e.avatar curUser.id = e.id curUser.name = e.name }) const userList = ref(new Map()) //åœ¨çº¿ç”¨æˆ· const chatData = ref&lt;ChatDataItem[]&gt;([]) //ç¾¤èŠçš„ä¿¡æ¯ // ç›‘å¬ welcome socket.on('welcome', ({ name, uList }) =&gt; { uList.forEach((item: any[]) =&gt; { const [id, value] = item userList.value.set(id, value) }) chatData.value.push({ type: 'tips', id: Math.random().toString().split('.')[1].slice(0, 10), content: 'æ¬¢è¿' + name + 'åŠ å…¥ç¾¤èŠ~', }) }) // ç¾¤èŠå‘é€æ¶ˆæ¯ const handleSend = (v: string) =&gt; { const obj = { id: Math.random().toString().split('.')[1].slice(0, 10), name: curUser.name, avatar: curUser.avatar, content: v, userId: curUser.id, } // åœ¨ chatData ä¸­æ–°å¢ä¸€æ¡æ•°æ®ï¼Œè¡¨ç¤ºè‡ªå·±å‘é€çš„ const type: 'me' = 'me' chatData.value.push(Object.assign({}, { type }, obj)) // å‘å‡ºsendäº‹ä»¶ï¼Œå°†æ¶ˆæ¯å‘é€å‡ºå» socket.emit('send', obj) } // ç›‘å¬ç¾¤èŠæ¶ˆæ¯çš„å¹¿æ’­ socket.on('message', (e: any) =&gt; { const msg = Object.assign({}, e, { type: 'your' }) as ChatDataItem chatData.value.push(msg) }) const chatUserId = ref('') //ç§èŠç”¨æˆ·id const chatUser = ref(null) //ç§èŠç”¨æˆ·ä¿¡æ¯ const chatType = ref('qunliao') //èŠå¤©ç±»å‹ // ç‚¹å‡»ç”¨æˆ·å¤´åƒç§èŠ const handleClickAvatar = (e:any) =&gt; { if (e.id === curUser.id) { return } if(e.name == undefined){ chatType.value = 'qunliao' return } chatType.value = 'siliao' chatUserId.value = e.id //ç§èŠå¯¹è±¡id chatUser.value = e //ç§èŠå¯¹è±¡ const u = userList.value.get(chatUserId.value) // ç‚¹å‡»å¤´åƒå»æ‰è¡¨ç¤ºå·²è¯»å»æ‰çº¢ç‚¹ if (u) { u.new = false } } const userChatData = ref&lt;Map&lt;string, ChatDataItem[]&gt;&gt;(new Map()) // ç§èŠå‘é€æ¶ˆæ¯ const handleSendUser = (v: string) =&gt; { const obj = { id: Math.random().toString().split('.')[1].slice(0, 10), name: curUser.name, avatar: curUser.avatar, content: v, userId: curUser.id, sendUserId: chatUserId.value, } // åœ¨ userChatData ä¸­æ–°å¢ä¸€æ¡æ•°æ®ï¼Œè¡¨ç¤ºè‡ªå·±å‘é€çš„ const type: 'me' = 'me' if (!userChatData.value.has(chatUserId.value)) { userChatData.value.set(chatUserId.value, []) } const _chatData = userChatData.value.get(chatUserId.value) ?? [] _chatData.push(Object.assign({}, { type }, obj)) // å‘å‡ºsendäº‹ä»¶ï¼Œå°†æ¶ˆæ¯å‘é€å‡ºå» socket.emit('send-user', obj) } // ç§èŠç›‘å¬æ¥å—æ¶ˆæ¯ socket.on('message-user', (e: any) =&gt; { const msg = Object.assign({}, e, { type: 'your' }) as ChatDataItem const sendId = e.userId if (!userChatData.value.has(sendId)) { userChatData.value.set(sendId, []) } const chatData = userChatData.value.get(sendId) ?? [] chatData.push(msg) // ç»™å‘é€æ¶ˆæ¯çš„idæ ‡è®°æ–°ä¿¡æ¯ const u = userList.value.get(sendId) if (u) { u.new = true } }) // ç›‘å¬é€€å‡º socket.on('quit', (id: string) =&gt; { const user = userList.value.get(id) userList.value.delete(id) chatData.value.push({ type: 'tips', id: Math.random().toString().split('.')[1].slice(0, 10), content: user?.name + 'é€€å‡ºç¾¤èŠ~', }) }) return{ handleJoin, curUser, userList, chatType, // ç¾¤èŠ ...{chatData , handleSend , handleClickAvatar}, // ç§èŠ ...{userChatData , chatUserId, chatUser , handleSendUser}, }} Nodeåç«¯å®ç°ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546import { Server } from 'socket.io'// å¼€å¯corsè·¨åŸŸconst io = new Server(5433, { cors: true })let userList = new Map() io.on('connection', socket =&gt; { //å®ä¾‹åœ¨è¿æ¥å’Œé‡æ–°è¿æ¥æ—¶è§¦å‘ // ç›‘å¬åŠ å…¥ç”¨æˆ·åŠ å…¥ socket.on('join', e =&gt; { userList.set(socket.id, e) // åŠ å…¥æˆåŠŸåè¿”å›åŠ å…¥æˆåŠŸçš„äº‹ä»¶ socket.emit('joined', Object.assign({}, e, { id: socket.id })) const uList = [...userList.entries()] // è§¦å‘å¹¿æ’­ socket.broadcast.emit('welcome', { ...e, uList, }) // è‡ªå·±å±•ç¤ºåŠ å…¥çš„ä¿¡æ¯ socket.emit('welcome', { ...e, uList, }) }) // ç›‘å¬æ¶ˆæ¯å‘é€ socket.on('send', e =&gt; { // æ¥å—åˆ°æ¶ˆæ¯ç»™ä»–å¹¿æ’­å‡ºå» æ‰€æœ‰è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯éƒ½ä¼šå—åˆ°å¹¿æ’­çš„ä¿¡æ¯ socket.broadcast.emit('message', e) }) // ç›‘å¬ç§èŠæ¶ˆæ¯çš„å‘é€ socket.on('send-user', e =&gt; { const sendUserId = e.sendUserId socket.to(sendUserId).emit('message-user', e) }) // ç”¨æˆ·ç¦»å¼€ socket.on('disconnecting', () =&gt; { //socketå¤±å»é“¾æ¥æ—¶è§¦å‘ï¼ŒåŒ…æ‹¬å…³é—­æµè§ˆå™¨ï¼Œä¸»åŠ¨æ–­å¼€ï¼Œæ‰çº¿ç­‰æƒ…å†µ const bool = userList.delete(socket.id) // å¦‚æœæœ‰ç”¨æˆ·ç¦»å¼€ï¼Œåœ¨è¿›è¡Œå¹¿æ’­ï¼ˆå› ä¸ºåªæ‰“å¼€é¡µé¢ä¸è¿›å…¥å…³é—­é¡µé¢ä¹Ÿä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ï¼‰ bool &amp;&amp; socket.broadcast.emit('quit', socket.id) }) })console.log('æœåŠ¡å¯åŠ¨..');","link":"/2023/08/04/vue/%E8%81%8A%E5%A4%A9%E5%AE%A4/"}],"tags":[{"name":"git","slug":"git","link":"/tags/git/"},{"name":"Vue","slug":"Vue","link":"/tags/Vue/"},{"name":"NodeJs","slug":"NodeJs","link":"/tags/NodeJs/"},{"name":"Element UI","slug":"Element-UI","link":"/tags/Element-UI/"},{"name":"Vite","slug":"Vite","link":"/tags/Vite/"},{"name":"Node","slug":"Node","link":"/tags/Node/"},{"name":"WebSocket","slug":"WebSocket","link":"/tags/WebSocket/"}],"categories":[{"name":"git","slug":"git","link":"/categories/git/"},{"name":"Vue","slug":"Vue","link":"/categories/Vue/"}],"pages":[{"title":"","text":"ä¸ªäººç®€ä»‹ ğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ª å†²é¸­ï¼ï¼ï¼ï¼ åšä¿¡ä»£ç æ”¹å˜ä¸–ç•Œ!!","link":"/about/index.html"},{"title":"","text":".empty{ height: 145px; }","link":"/about/style.css"}]}